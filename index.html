<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>bootstrap&middot;geosearch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- CSS -->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
    <!-- <link rel="stylesheet" href="https://s3-us-west-1.amazonaws.com/patterns.esri.com/files/calcite-web/1.0.0-beta.7/css/calcite-web.min.css"> -->

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <!-- Load Leaflet from CDN-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet-src.js"></script>

    <script src="https://unpkg.com/esri-leaflet@2.0.3/dist/esri-leaflet-debug.js"></script>

    <!-- this demo plugin bundles the needed code from Esri Leaflet and Esri Leaflet Geocoder -->
    <script src="./built/bootstrap-geocoder.js"></script>

    <style type="text/css">

      html,
      body {
        height: 100%;
        /* The html and body elements cannot have any padding or margin. */
      }

      #map {
        position: absolute;
        height: 100%;
        width: 100%;
        display: none;
      }

      #intro {
        min-height: 100%;
        height: auto !important;
        height: 100%;
      }

      .container {
        width: auto;
        max-width: 600px;
      }

      .input-group {
        width: 100%;
      }

      li {
        padding: 3px 20px;
        margin: 0;
      }

      li:hover{
        background: #7FDFFF;
        border-color: #7FDFFF;
      }

      .geocoder-control-selected{
        background: #7FDFFF;
        border-color: #7FDFFF;
      }

      ul li {
        list-style-type: none;
      }

    </style>
  </head>

  <body>
    <!-- Part 1: Wrap all page content here -->
    <div id= "map"></div>
    <div id="intro">
      <!-- Begin page content -->
      <div class="container">

        <div class="page-header">
          <h3>where's healthy food in Philly near me?</h3>
        </div>
        <input class="form-control"
          type="text"
          id="address"
          autocomplete="off"
          autofocus
        />
      </div>
    </div>

  <script>
      // 2006 pemberton st philadelphia
      var map = L.map('map').setView([39, -75], 15);
      L.esri.basemapLayer('Gray').addTo(map);
      
      // only show geocoding matches in and very near philly
      var search = BootstrapGeocoder.search({
        inputTag: 'address',
        placeholder: 'ex. LAX',
        searchBounds: L.latLngBounds([39.7,-75.4], [41,-75]) 
      }).addTo(map);


      // once you have an address match, use it to generate a walkshed
      search.on('results', function(e){
        var location = e.results[0].latlng.lng + ',' + e.latlng.lat;

        /* 
          create a free account at https://developers.arcgis.com
          and generate a service proxy to authenticate when generating walksheds
          ./applications/ > licensing

          another option would be to append a static token
          http://resources.arcgis.com/en/help/arcgis-rest-api/#/Service_Area_service_with_synchronous_execution/02r3000000n2000000/
        */
        L.esri.request('http://utility.arcgis.com/usrsvcs/appservices/CRigcnlF0U4fwxCG/rest/services/World/ServiceAreas/NAServer/ServiceArea_World/solveServiceArea', {
            facilities: location,
            outSr: 4326,
            
            /* 
            this is gnarly, but it gives you fine grained control to generate drive times, distances, trucking, walk etc.
            */
            travelMode: "{\"attributeParameterValues\": [{\"parameterName\": \"Restriction Usage\", \"attributeName\": \"Walking\", \"value\": \"PROHIBITED\"}, {\"parameterName\": \"Restriction Usage\", \"attributeName\": \"Preferred for Pedestrians\", \"value\": \"PREFER_LOW\"}, {\"parameterName\": \"Walking Speed (km/h)\", \"attributeName\": \"WalkTime\", \"value\": 5}], \"description\": \"Follows paths and roads that allow pedestrian traffic and finds solutions that optimize travel time. The walking speed is set to 5 kilometers per hour.\", \"impedanceAttributeName\": \"WalkTime\", \"simplificationToleranceUnits\": \"esriMeters\", \"uturnAtJunctions\": \"esriNFSBAllowBacktrack\", \"restrictionAttributeNames\": [\"Preferred for Pedestrians\", \"Walking\"], \"useHierarchy\": false, \"simplificationTolerance\": 2, \"timeAttributeName\": \"WalkTime\", \"distanceAttributeName\": \"Miles\", \"type\": \"WALK\", \"id\": \"caFAgoThrvUpkFBW\", \"name\": \"Walking Time\"}",
            defaultBreaks: [15] // minutes
        }, function(error, response){
          if(error){
            console.log(error);
          } else {
            // once you have a walkshed, turn it into geojson and use it to query your feature service

            var walkShed = L.esri.Util.arcgisToGeoJSON(response.saPolygons.features[0]);
            var walkShedFeatureCollection = {
              type: "FeatureCollection",
              features: [ walkShed ]
            }

            L.geoJSON(walkShedFeatureCollection).addTo(map);

            var query = L.esri.query({
                url:'https://services.arcgis.com/fLeGjb7u4uXqeF9q/arcgis/rest/services/Healthy_Corner_Stores/FeatureServer/0'
            });

            // healthy in the callback is a geojson feature collection, so you can dig into feature attributes
            query.intersects(walkShed).run(function(error, healthy, raw){
                
                document.getElementById('intro').style.display = 'none';
                document.getElementById('map').style.display = 'block';
                // http://leafletjs.com/reference.html#map-invalidatesize
                map.invalidateSize();
                map.setView([39.95023044499703, -75.16538858413], 15);
                L.geoJson(healthy).addTo(map);
            });
          }
        });
    
      });
    </script>

  </body>
</html>
